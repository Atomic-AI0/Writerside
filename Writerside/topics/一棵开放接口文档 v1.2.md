# 一棵开放接口文档 v1.2

## 0x00 修订历史

- **2019年12月17日** 黎欣 初稿
- **2019年12月22日** 黎欣 完善v1版接口文档
- **2020年1月10日** 黎欣 补充传感器参数说明
- **2020年1月13日** 黎欣 增加获取最新数据接口
- **2020年2月10日** 黎欣 增加设备状态字段和修改上报周期

## 0x01 API概览

| **API**                                             | **描述**                 |
| --------------------------------------------------- | ------------------------ |
| GET /apis/v1/token                                  | 获取接口访问授权码       |
| GET /apis/echo/v1/devices                           | 获取用户账户下设备列表   |
| GET /apis/echo/v1/device/:sn                        | 获取设备详情             |
| POST /apis/echo/v1/device/:sn                       | 修改设备上报周期         |
| GET /apis/echo/v1/device/:sn/datapoints             | 按时间段获取设备采集数据 |
| GET /apis/echo/v1/device/:sn/datapoints/incremental | 增量获取设备的采集数据   |
| GET /apis/echo/v1/device/:sn/datapoints/latest      | 获取最新一包设备采集数据 |

## 0x02 快速入门

### 概述

文档中所介绍接口请求均为HTTP协议，接口请求支持URL传参以及RequestBody传参（支持PUT，POST），接口响应暂时仅支持JSON格式，如无特殊说明，则所有接口都需要传入授权码请求头：Authorization，该字段值通过请求下文中：/apis/v1/token 接口获得。

备注：

- 本文中关于 时间戳如无特指，则统一为[Unix Time](https://en.wikipedia.org/wiki/Timestamp)格式，如：1578846463。

### 请求结构示例

以下是获取设备列表接口的请求地址:

```
<https://cloud.insentek.com/apis/echo/v1/devices?offset=0&limit=20>
```

- https为通信协议；
- cloud.insentek.com是开放接口服务器域名
- /apis/echo/v1/devices是接口具体路径
- ?offset=1&limit=20是接口所需的URL参数

完整的请求示例(curl)：

```
curl -H 'Content-Type: application/json' \
-H 'Authorization: AccessToken' \
'<https://cloud.insentek.com/apis/echo/v1/devices?offset=0&limit=20'>
```

**备注**：如果是通过PostMan或CURL等工具发起请求，请添加请求头：Content-Type: application/json

### 全局错误码

| **错误码** | **错误信息**                                                 | **错误描述**                                                 |
| ---------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| \-1        | The service is temporarily unavailable.                      | 服务暂时不可用                                               |
| 0          | ok                                                           | 请求成功                                                     |
| 10001      | Illegal access token.                                        | 非法的请求Token                                              |
| 10002      | Invalid 'appid' or 'secret'.                                 | 错误的Appid或Secret                                          |
| 11001      | No access token found in the request headers: Authorization. | 请求头中没有找到Token                                        |
| 11002      | Missing argument: 'appid'                                    | 缺少appid参数                                                |
| 11003      | Missing argument: 'secret'                                   | 缺少secret参数                                               |
| 23001      | The limit must be less than 100.                             | 每次获取的设备数量不能超过100                                |
| 23002      | The time range should not be longer than one month.          | 设备采集数据时间范围不能超过一个月                           |
| 23003      | The rollback timestamp exceeds range of device collect time. | 回拨的时间戳不能晚于设备最新采集时间，也不能早于最新采集时间的7天前 |
| 20001      | Begin timestamp must less than end timestamp.                | 起始时间不能晚于结束时间                                     |
| 20002      | Illegal time range format.                                   | 错误的时间范围格式                                           |
| 20003      | Illegal timestamp.                                           | 错误的时间戳                                                 |
| 24001      | The device does not exist.                                   | 访问的设备不存在                                             |
| 25001      | The user has no privilege to access the device.              | 当前用户没有该设备的访问权限                                 |

### 返回结果

```
// 成功示例
{
  	"code": 0,
    "message": "ok",    
	  ...data
}
// 错误示例
{
  	"code": 10001,
  	"message": "Illegal access token.",
  	"requestId": "evwEPQUWkqFNgUunTrbTUuEP3QNWdBvQ"
}
```

## 0x03 API.获取接口授权码

### 描述

接口地址：/apis/v1/token，使用该接口时建议将返回的token信息在您的应用程序中缓存起来，以提高接口访问性能，每次使用时检查是否过期，如果即将过期或已经过期，请及时重新创建token，避免影响业务。

该接口多次请求后，之前生成的token将会失效，如果存在多个调用方，建议共享token，或者建立多个appid。

### 请求参数

| **名称** | **类型** | **是否必需** | **描述**                     |
| -------- | -------- | ------------ | ---------------------------- |
| appid    | String   | 是           | 在开放接口平台创建的应用ID   |
| secret   | String   | 是           | 在开放接口平台创建的应用密钥 |

### 返回参数

| **名称** | **类型** | **描述**                       |
| -------- | -------- | ------------------------------ |
| token    | String   | 获取的授权码                   |
| expires  | Integer  | 授权码的有效使用时长，单位：秒 |

### 示例

```
// 请求示例
GET  <https://cloud.insentek.com/apis/v1/token?appid=test&secret=test>
// 响应示例
{
  	"code": 0,
    "message": "ok",
    "token": "wj3eZGGKofgv7GyzuCmuoLukVUvUsuDq",    
    "expires": 7200
}
```

## 0x04 API.获取设备列表

### 描述

接口地址：/apis/echo/v1/devices，获得账户下的所有一棵的基本信息。

### 请求参数

| **名称** | **类型** | **是否必需** | **描述**                                      |
| -------- | -------- | ------------ | --------------------------------------------- |
| offset   | Integer  | 否           | 查询起始索引，默认为0                         |
| limit    | Integer  | 否           | 每次查询返回设备数量，默认值：20，最大值：100 |

### 返回参数

| **名称**          | **类型** | **描述**                                                   |
| ----------------- | -------- | ---------------------------------------------------------- |
| total             | Integer  | 设备总数                                                   |
| offset            | Integer  | 当前查询起始索引                                           |
| limit             | Integer  | 当前查询期望返回设备数量                                   |
| list              | Array    | 设备集合                                                   |
| sn                | String   | 设备序列号                                                 |
| name              | String   | 设备名称                                                   |
| crop              | String   | 作物类型                                                   |
| benchmark         | Integer  | 一棵跑分                                                   |
| batteryVolt       | Float    | 设备电压                                                   |
| latestCollectTime | Integer  | 最新的采集时间戳                                           |
| longitude         | String   | 纬度                                                       |
| latitude          | String   | 经度                                                       |
| position          | String   | 安装位置：温室或大田                                       |
| location          | String   | 设备位置信息                                               |
| status            | Object   | 设备状态信息                                               |
| status.state      | String   | 设备状态枚举: NoData, Offline, Abnormal, LowPower, Working |
| status.tag        | String   | 设备状态对应的中文说明：无数据，离线，异常，低电量，工作中 |
| status.message    | String   | 设备状态的详细描述                                         |

### 示例

```
// 请求示例
GET  <https://cloud.insentek.com/apis/echo/v1/devices?offset=0&limit=20>
// 响应示例
{
    "code": 0,
    "message": "ok",
    "total": 1,
    "offset": 0,
    "limit": 20,
    "list": [
        {
            "sn": "861011047280180",
            "name": "示例一棵",
            "crop": "草莓",
            "benchmark": 102,
            "batteryVolt": 4.22,
            "latestCollectTime": 1575745200,
            "longitude": "108.9656766",
            "latitude": "34.241748",
            "position": "greenhouse",
            "location": "中铁·第壹国际(西安市碑林区)",
            "status": {
                "state": "Working",
                "tag": "工作中"，
                "message": ""
            }
        }
    ]
}
```

## 0x05 API.获取设备详情

### 描述

接口地址：/apis/echo/v1/device/:sn，获得设备详细信息。

### 请求参数

| **名称** | **类型** | **是否必需** | **描述**   |
| -------- | -------- | ------------ | ---------- |
| sn       | String   | 是           | 设备序列号 |

### 返回参数

| **名称**          | **类型** | **描述**                                                   |
| ----------------- | -------- | ---------------------------------------------------------- |
| sn                | String   | 设备序列号                                                 |
| name              | String   | 设备名称                                                   |
| benchmark         | Integer  | 一棵跑分                                                   |
| crop              | String   | 作物类型                                                   |
| longitude         | String   | 纬度                                                       |
| latitude          | String   | 经度                                                       |
| position          | String   | 安装位置：温室或大田                                       |
| location          | String   | 设备位置信息                                               |
| batteryVolt       | Float    | 设备电压                                                   |
| latestCollectTime | Integer  | 最新的采集时间戳                                           |
| versions          | Object   | 版本信息                                                   |
| versions.firmware | String   | 固件版本                                                   |
| versions.software | String   | 软件版本                                                   |
| versions.hardware | String   | 硬件版本                                                   |
| status            | Object   | 设备状态信息                                               |
| status.state      | String   | 设备状态枚举: NoData, Offline, Abnormal, LowPower, Working |
| status.tag        | String   | 设备状态对应的中文说明：无数据，离线，异常，低电量，工作中 |
| status.message    | String   | 设备状态的详细描述                                         |

### 示例

```
// 请求示例
GET  <https://cloud.insentek.com/apis/echo/v1/860640046469542>
// 响应示例
{
    "code": 0,
    "message": "ok",
    "benchmark": 157,
    "sn": "860640046469542",
    "name": "昌平金六环5",
    "crop": "草莓",
    "position": "greenhouse",
    "longitude": "116.26408775",
    "latitude": "40.18535084",
    "location": 157,
    "batteryVolt": 3.59,
    "latestCollectTime": 1577059200,
    "status": {
        "state": "Working",
        "tag": "工作中"，
        "message": ""
    },
    "versions": {
        "firmware": "M5310-A-MCMH0S04",
        "software": "Echo-M5310A-ONENET-191203",
        "hardware": "Echo_Main_M5310A-V1.1"
    }
}
```

## 0x06 API.修改设备上报周期

### 描述

接口地址：/apis/echo/v1/device/:sn，修改设备详细信息，暂只支持修改上报周期。

### 请求参数

| **名称**    | **类型** | **是否必需** | **描述**                               |
| ----------- | -------- | ------------ | -------------------------------------- |
| sn          | String   | 是           | 设备序列号                             |
| reportCycle | Integer  | 是           | 上报周期（分钟），可选值： 30, 60, 120 |

### 示例

```
// 请求示例
POST  <https://cloud.insentek.com/apis/echo/v1/860640046469542>
// body
{reportCycle: 30}
// 响应示例
{
    "code": 0,
    "message": "ok",
}
```

## 0x07 API.获取设备采集数据

### 描述

接口地址： /apis/echo/v1/device/:sn/datapoints

### 请求参数

| **名称** | **类型** | **是否必需** | **描述**                                                 |
| -------- | -------- | ------------ | -------------------------------------------------------- |
| sn       | String   | 是           | 设备序列号                                               |
| range    | String   | 否           | 查询的起始时间与结束时间戳，不填时默认返回今日采集数据： |

### 返回参数

| **名称**   | **类型** | **描述**                       |
| ---------- | -------- | ------------------------------ |
| datapoints | Object   | 采集数据点信息                 |
| timeline   | Array    | 采集时间戳，无数据时为空数组   |
| sensors    | Array    | 传感器数据信息                 |
| name       | String   | 采集数据名称                   |
| values     | Array    | 采集数据数组，无数据时为空数组 |

### 示例

```
// 请求示例
GET  <https://cloud.insentek.com/apis/echo/v1/device/860640046469542/datapoints?range=1577075053,1577075127>
// 响应示例
{
    "code": 0,
    "message": "ok",
    "datapoints": {
        "timeline": [
            1577030400,
            1577037600,
            1577044800,
            1577052000
        ],
        "sensors": [
            {
                "name": "Illuminance",
                "values": [0, 0, 0, 0]
            },
            {
                "name": "SoilTemperature",
                "values": [16.3,16.3,16.1,16]
            },
            {
                "name": "AirTemperature",
                "values": [12.2,12.1,11.6,11.1]
            },
            {
                "name": "Humidity",
                "values": [93.2,93.1,93.5,93.9]
            },
            {
                "name": "Moisture",
                "values": [27.3,27.2,27.2,27.1]
            },
            {
                "name": "EC",
                "values": [1376.8,1376.9,1376.9,1375.7]
            }
        ]
    }
}
```

### 采集相关参数说明

| **名称**        | **参数**   | **数据类型** | **单位** | **监测范围** |
| --------------- | ---------- | ------------ | -------- | ------------ |
| Illuminance     | 光照强度   | Integer      | Lux      | 0-120000     |
| SoilTemperature | 土壤温度   | Float        | °C       | \-20~65      |
| AirTemperature  | 空气温度   | Float        | °C       | \-20~65      |
| Humidity        | 空气湿度   | Float        | %        | 0-100        |
| Moisture        | 土壤水分   | Float        | %        | \-           |
| EC              | 土壤电导率 | Float        | μS/cm    | 0~6000       |

## 0x08 API.增量获取设备采集数据

### 描述

接口地址： /apis/echo/v1/device/:sn/datapoints/incremental ，增量获取设备的采集数据。该接口返回**上次请求时间**到**本次请求时间**所产生的所有采集数据。如果是第一次请求该接口，则返回设备绑定至今的所有采集数据，更早期的数据可通过**获取设备采集数据接口**指定时间范围来获取。

### 请求参数

| **名称** | **类型** | **是否必需** | **描述**                         |
| -------- | -------- | ------------ | -------------------------------- |
| sn       | String   | 是           | 设备序列号                       |
| rollback | Integer  | 否           | 将上次同步时间回滚至特定时间戳。 |

### 返回参数

| **名称**              | **类型** | **描述**                       |
| --------------------- | -------- | ------------------------------ |
| previousSyncTimestamp | Integer  | 上一次同步时，最新的采集时间戳 |
| datapoints            | Object   | 采集数据点信息                 |
| timeline              | Array    | 采集时间戳，无数据时为空数组   |
| sensors               | Array    | 传感器数据信息                 |
| name                  | String   | 采集数据名称                   |
| values                | Array    | 采集数据数组，无数据时为空数组 |

### 示例

```
// 请求示例
GET  <https://cloud.insentek.com/apis/echo/v1/device/860640046469542/datapoints/incremental?rollback=1577075053>
// 响应示例
{
    "message": "ok",
    "previousSyncTimestamp": 1577052000,
    "datapoints": {
        "timeline": [
            1577030400,
            1577037600,
            1577044800,
            1577052000
        ],
        "sensors": [
            {
                "name": "Illuminance",
                "values": [0, 0, 0, 0]
            },
            {
                "name": "SoilTemperature",
                "values": [16.3,16.3,16.1,16]
            },
            {
                "name": "AirTemperature",
                "values": [12.2,12.1,11.6,11.1]
            },
            {
                "name": "Humidity",
                "values": [93.2,93.1,93.5,93.9]
            },
            {
                "name": "Moisture",
                "values": [27.3,27.2,27.2,27.1]
            },
            {
                "name": "EC",
                "values": [1376.8,1376.9,1376.9,1375.7]
            }
        ]
    }
}
```

## 0x09 API.获取最新设备采集数据

### 描述

接口地址： /apis/echo/v1/device/:sn/datapoints/latest

### 请求参数

| **名称** | **类型** | **是否必需** | **描述**   |
| -------- | -------- | ------------ | ---------- |
| sn       | String   | 是           | 设备序列号 |

### 返回参数

| **名称**               | **类型** | **描述**                                                    |
| ---------------------- | -------- | ----------------------------------------------------------- |
| latestCollectTimestamp | Integer  | 设备最新的采集时间戳，如果绑定后未曾上报过数据，则该字段为0 |
| datapoints             | Object   | 采集数据点信息                                              |
| timeline               | Array    | 采集时间戳，无数据时为空数组                                |
| sensors                | Array    | 传感器数据信息                                              |
| name                   | String   | 采集数据名称                                                |
| values                 | Array    | 采集数据数组，无数据时为空数组                              |

### 示例

```
// 请求示例
GET  <https://cloud.insentek.com/apis/echo/v1/device/860640046469542/datapoints/latest>
// 响应示例
{
    "message": "ok",
    "latestCollectTimestamp": 1577052000,
    "datapoints": {
        "timeline": [
            1577052000
        ],
        "sensors": [
            {
                "name": "Illuminance",
                "values": [0]
            },
            {
                "name": "SoilTemperature",
                "values": [16.3]
            },
            {
                "name": "AirTemperature",
                "values": [12.2]
            },
            {
                "name": "Humidity",
                "values": [93.2]
            },
            {
                "name": "Moisture",
                "values": [27.3]
            },
            {
                "name": "EC",
                "values": [1376.8]
            }
        ]
    }
}
```